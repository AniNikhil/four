<!DOCTYPE HTML>
<html>
<head>
  <title>Flask-SocketIO Test</title>
  <link href="{{ url_for('static', filename='leaflet/leaflet.css') }}" rel="stylesheet">
  <style type="text/css">
      html, body {
          height: 100%;
          margin: 0;
      }

      #map {
          min-height: 100%; 
      }
  </style>
  <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.5/socket.io.min.js"></script>
  <script src="{{ url_for('static', filename='leaflet/leaflet.js') }}"></script>
  <script type="text/javascript" charset="utf-8">
    $(document).ready(function() {
      namespace = '/';
      var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);
      
      window.setInterval(function() {
          socket.emit('send_random');
      }, 1000);
      
      var polylines = [];
      socket.on('current_solution', function(path) {
        for (i = 0; i < polylines.length; i++) { 
          console.log(polylines[i]);
          map.removeLayer(polylines[i]);
          }

        for (i = 0; i < path.length - 1; i++) { 

          var source_lat = path[i][0];
              source_lon = path[i][1];
              
          var destination_lat = path[i+1][0];
              destination_lon = path[i+1][1];
              
          var pointA = new L.LatLng(source_lat, source_lon);
          var pointB = new L.LatLng(destination_lat, destination_lon);
          var pointList = [pointA, pointB];
          
          var polyline = new L.Polyline(pointList, {
            color: '#0000ff',
            weight: 3,
            opacity: 1,
            smoothFactor: 1
            });

          polyline.addTo(map);
          polylines.push(polyline);
        }
        
      });
      
      var best_polylines = [];
      socket.on('best_solution', function(path) {
        for (i = 0; i < best_polylines.length; i++) { 
          map.removeLayer(best_polylines[i]);
          }

        for (i = 0; i < path.length - 1; i++) { 

          var source_lat = path[i][0];
              source_lon = path[i][1];
              
          var destination_lat = path[i+1][0];
              destination_lon = path[i+1][1];
              
          var pointA = new L.LatLng(source_lat, source_lon);
          var pointB = new L.LatLng(destination_lat, destination_lon);
          var pointList = [pointA, pointB];
          
          var polyline = new L.Polyline(pointList, {
            color: '#d4222a',
            weight: 3,
            opacity: 1,
            smoothFactor: 1
            });

          polyline.addTo(map);
          best_polylines.push(polyline);
        }
        
      });
      
    var layers = {
      'osm': 'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
      'gm': 'http://mt0.google.com/vt/lyrs=y&hl=en&x={x}&y={y}&z={z}&s=Ga',
      'nasa': 'http://tileserver.maptiler.com/nasa/{z}/{x}/{y}.jpg'
      };

    var map = L.map('map').setView([39, -98], 5);
    var osm_layer = L.tileLayer(layers['osm']);
    map.addLayer(osm_layer);
    var current_layer = osm_layer;

    var icon_city = L.icon({
      iconUrl: 'static/images/city.png',
      iconSize: [20, 20], // size of the icon
      iconAnchor: [9, 6], // point of the icon which will correspond to marker's location
      popupAnchor: [8, -5] // point from which the popup should open relative to the iconAnchor
      });
    
    
    var markers_array = [];
    {% for id, properties in cities.items() %}  
      var marker = L.marker([
        {{ properties['latitude'] }}, 
        {{ properties['longitude'] }}], 
        );
      
      marker.bindPopup("{% for property in properties %}\
      <b>{{ property }}</b>: {{ properties[property] }}<br>{% endfor %}<br>\
      <input type='hidden' name='id' id='id' value={{ id }}>\
      <input type='button' value='Connect' class='btn btn-round btn-danger' onclick='return connect_to_device()'/>");
      
      marker.bindTooltip("{{ properties['name'] }}", {
        permanent: false, 
        }
      );
      marker.setIcon(icon_city), 
      markers_array.push(marker);
      marker.addTo(map);
      
      function clearMap() {
          for(i in m._layers) {
              if(m._layers[i]._path != undefined) {
                  try {
                      m.removeLayer(m._layers[i]);
                  }
                  catch(e) {
                      console.log("problem with " + e + m._layers[i]);
                  }
              }
          }
      }
    {% endfor %}
  });
  </script>
</head>
<body>
  <div id="map">
</body>
</html>
